<page-header
  ng-if="ctrl.state.viewReady"
  title="'命名空间访问管理'"
  breadcrumbs="[
    { label:'命名空间', link:'kubernetes.resourcePools' },
    {
      label:ctrl.pool.Namespace.Name,
      link: 'kubernetes.resourcePools.resourcePool',
      linkParams:{id: ctrl.pool.Namespace.Name}
    },
     '访问管理'
     ]"
  reload="true"
>
</page-header>

<kubernetes-view-loading view-ready="ctrl.state.viewReady"></kubernetes-view-loading>

<div ng-if="ctrl.state.viewReady">
  <div class="row" ng-if="ctrl.pool">
    <div class="col-sm-12">
      <rd-widget>
        <rd-widget-header icon="layers" title-text="命名空间"></rd-widget-header>
        <rd-widget-body>
          <table class="table">
            <tbody>
              <tr>
                <td class="!pl-0">名称</td>
                <td>
                  {{ ctrl.pool.Namespace.Name }}
                </td>
              </tr>
            </tbody>
          </table>
        </rd-widget-body>
      </rd-widget>
    </div>
  </div>

  <div class="row">
    <div class="col-sm-12">
      <rd-widget ng-if="ctrl.availableUsersAndTeams">
        <rd-widget-header icon="user-x" title-text="创建访问"></rd-widget-header>
        <rd-widget-body>
          <form class="form-horizontal">
            <div class="form-group">
              <div
                ng-if="!ctrl.isRBACEnabled"
                class="small mx-[15px] mb-6 flex gap-1 rounded-lg border border-solid border-warning-5 bg-warning-2 p-4 text-warning-8 th-highcontrast:bg-yellow-11 th-highcontrast:text-white"
              >
                <div class="mt-0.5">
                  <pr-icon icon="'alert-triangle'" feather="true" class-name="'text-warning-7 th-dark:text-white th-highcontrast:text-white'"></pr-icon>
                </div>
                <div>
                  <p> 您的集群未启用 Kubernetes 基于角色的访问控制 (RBAC)。 </p>
                  <p> 这意味着您无法使用 Portainer RBAC 功能根据用户角色来管理环境资源的访问。 </p>
                  <p class="mb-0">
                    要启用 RBAC，请使用 <a
                      class="th-highcontrast:text-blue-4 th-dark:text-blue-7"
                      href="https://kubernetes.io/docs/concepts/overview/components/#kube-apiserver"
                      target="_blank"
                      >API 服务器</a
                    >&nbsp;并将 <code class="bg-gray-4 box-decoration-clone th-highcontrast:bg-black th-dark:bg-black">--authorization-mode</code> 标志设置为一个逗号分隔的列表，其中包括 <code class="bg-gray-4 th-highcontrast:bg-black th-dark:bg-black">RBAC</code>，例如：<code class="bg-gray-4 box-decoration-clone th-highcontrast:bg-black th-dark:bg-black">kube-apiserver --authorization-mode=Example1,RBAC,Example2</code>。
                  </p>
                </div>
              </div>
              <span class="col-sm-12 small text-warning">
                <p class="vertical-center">
                  <pr-icon icon="'alert-triangle'" mode="'warning'"></pr-icon>
                  添加用户访问将需要受影响的用户退出登录并重新登录以使更改生效。
                </p>
              </span>
            </div>
            <div class="form-group">
              <label class="col-sm-3 col-lg-2 control-label text-left" for="users-selector"> 选择用户和/或团队 </label>
              <div class="col-sm-9 col-lg-4">
                <span class="small text-muted" ng-if="ctrl.availableUsersAndTeams.length === 0">
                  尚未在环境中设置用户或团队访问权限。 转到
                  <a ui-sref="portainer.endpoints">环境视图</a> 来管理它们。
                </span>
                <namespace-access-users-selector
                  ng-if="ctrl.availableUsersAndTeams.length > 0"
                  input-id="users-selector"
                  value="ctrl.formValues.multiselectOutput"
                  options="ctrl.availableUsersAndTeams"
                  on-change="(ctrl.onUsersAndTeamsChange)"
                ></namespace-access-users-selector>
              </div>
            </div>

            <!-- actions -->
            <div class="form-group">
              <div class="col-sm-12">
                <button
                  type="submit"
                  class="btn btn-primary btn-sm vertical-center !ml-0"
                  ng-disabled="ctrl.formValues.multiselectOutput.length === 0 || ctrl.actionInProgress"
                  ng-click="ctrl.authorizeAccess()"
                  button-spinner="ctrl.actionInProgress"
                >
                  <span class="vertical-center" ng-hide="ctrl.state.actionInProgress"><pr-icon icon="'plus'" class="vertical-center"></pr-icon> 创建访问</span>
                  <span ng-show="ctrl.state.actionInProgress">创建访问中...</span>
                </button>
              </div>
            </div>
            <!-- !actions -->
          </form>
        </rd-widget-body>
      </rd-widget>
    </div>
  </div>

  <div class="row">
    <div class="col-sm-12">
      <access-datatable
        ng-if="ctrl.authorizedUsersAndTeams"
        title-text="Namespace access"
        title-icon="user-x"
        table-key="kubernetes_resourcepool_access"
        order-by="Name"
        dataset="ctrl.authorizedUsersAndTeams"
        remove-action="ctrl.unauthorizeAccess"
      >
      </access-datatable>
    </div>
  </div>
</div>
